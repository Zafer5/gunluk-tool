<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProInvoice: Kurumsal Fatura & Teklif Oluşturucu</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Kurumsal Renk Paleti Tanımlaması */
        :root {
            --color-primary: #4f46e5; /* Indigo-600 */
            --color-secondary: #059669; /* Emerald-600 */
            --color-background: #f9fafb; /* Gray-50 */
            --color-text: #1f2937; /* Gray-800 */
        }
        body {
            background-color: var(--color-background);
            color: var(--color-text);
            font-family: 'Inter', sans-serif;
        }
        /* Özel SVG Stil Ayarları (Daha profesyonel görünüm için) */
        .svg-icon path {
            fill: var(--color-primary);
        }
        .btn-primary {
            background-color: var(--color-primary);
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: #4338ca; /* Indigo-700 */
        }
        .btn-secondary {
            background-color: var(--color-secondary);
            transition: background-color 0.2s;
        }
        .btn-secondary:hover {
            background-color: #047857; /* Emerald-700 */
        }
        /* Scrollbar Gizleme (Daha temiz bir görünüm için) */
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .hide-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
    </style>
</head>
<body class="min-h-screen p-4 sm:p-8">

    <div id="app" class="max-w-7xl mx-auto bg-white shadow-2xl rounded-xl p-6 lg:p-10 border border-gray-200">

        <!-- Başlık -->
        <header class="mb-8 border-b pb-4 flex justify-between items-center">
            <h1 class="text-3xl font-extrabold text-gray-900 flex items-center">
                <svg class="w-8 h-8 mr-2 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V4m0 4v4m0 4v4m-6-4h12M12 20v-4m-6-4h12m-6-8H6a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-6"></path></svg>
                ProInvoice <span class="text-sm font-medium text-emerald-600 ml-2">Pro Sürüm</span>
            </h1>
            <div class="flex space-x-3">
                <button id="btnSave" class="btn-secondary text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:shadow-lg transition duration-150 flex items-center text-sm">
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path></svg>
                    Kaydet (Local)
                </button>
                <button id="btnExportPDF" class="btn-primary text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:shadow-lg transition duration-150 flex items-center text-sm">
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17H7V7h10v10zM7 7V3h10v4M7 17v4h10v-4M12 3v4m0 13v4m-7-13h14"></path></svg>
                    PDF İndir
                </button>
            </div>
        </header>

        <!-- 1. Panel: Verici ve Alıcı Bilgileri -->
        <section class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8 p-4 bg-indigo-50 rounded-lg border border-indigo-200">
            
            <!-- Veren Firma Bilgileri (Gönderen) -->
            <div class="lg:col-span-1 space-y-3 p-3 border-r lg:border-indigo-200">
                <h2 class="text-lg font-bold text-indigo-700 mb-2">Sizin Bilgileriniz</h2>
                <input type="text" id="senderName" class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 placeholder-gray-400 shadow-sm" placeholder="Şirket Adı / Adınız Soyadınız">
                <input type="text" id="senderAddress" class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 placeholder-gray-400 shadow-sm" placeholder="Adres Bilgisi">
                <input type="text" id="senderTaxId" class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 placeholder-gray-400 shadow-sm" placeholder="Vergi No / TCKN">
                <input type="email" id="senderEmail" class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 placeholder-gray-400 shadow-sm" placeholder="E-posta Adresi">
            </div>

            <!-- Alıcı Firma Bilgileri -->
            <div class="lg:col-span-1 space-y-3 p-3 border-r lg:border-indigo-200">
                <h2 class="text-lg font-bold text-indigo-700 mb-2">Müşteri Bilgileri</h2>
                <input type="text" id="recipientName" class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 placeholder-gray-400 shadow-sm" placeholder="Müşteri Şirket Adı">
                <input type="text" id="recipientContact" class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 placeholder-gray-400 shadow-sm" placeholder="İlgili Kişi">
                <input type="text" id="recipientTaxId" class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 placeholder-gray-400 shadow-sm" placeholder="Müşteri Vergi No">
                <input type="text" id="recipientAddress" class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 placeholder-gray-400 shadow-sm" placeholder="Müşteri Adresi">
            </div>

            <!-- Fatura Detayları -->
            <div class="lg:col-span-1 space-y-3 p-3">
                <h2 class="text-lg font-bold text-indigo-700 mb-2">Belge Detayları</h2>
                <input type="text" id="invoiceNumber" class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 placeholder-gray-400 shadow-sm" placeholder="Fatura No: INV-2024-001">
                <input type="date" id="invoiceDate" class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 placeholder-gray-400 shadow-sm">
                <input type="date" id="dueDate" class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 placeholder-gray-400 shadow-sm" placeholder="Vade Tarihi">
                <select id="taxRate" class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 shadow-sm bg-white">
                    <option value="0.20">KDV Dahil (%20)</option>
                    <option value="0.10">KDV Dahil (%10)</option>
                    <option value="0.00">KDV Hariç (Muaf)</option>
                </select>
            </div>

        </section>

        <!-- 2. Panel: Kalem Girişi -->
        <section class="mb-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">Hizmet/Ürün Kalemleri</h2>
            
            <div id="lineItemsContainer" class="space-y-4 mb-4">
                <!-- JS ile eklenecek kalemler buraya gelecek -->
            </div>

            <button id="addLineItem" class="btn-secondary text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:shadow-lg transition duration-150 flex items-center text-sm">
                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                Yeni Kalem Ekle
            </button>
        </section>
        
        <!-- 3. Panel: Hesaplama Özeti -->
        <section class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-10">
            
            <!-- Sol Taraf: Açıklama ve Notlar -->
            <div class="lg:col-span-1 space-y-4">
                <h3 class="text-lg font-semibold text-gray-700">Ek Açıklamalar</h3>
                <textarea id="notes" rows="4" class="w-full p-3 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 placeholder-gray-400 shadow-inner" placeholder="Ödeme koşulları, proje detayları veya ek notlar buraya yazılabilir."></textarea>
                <h3 class="text-lg font-semibold text-gray-700">Ödeme Bilgileri</h3>
                <textarea id="paymentDetails" rows="3" class="w-full p-3 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 placeholder-gray-400 shadow-inner" placeholder="Banka Adı: TR... IBAN: ... Hesap Sahibi: ..."></textarea>
            </div>
            
            <!-- Sağ Taraf: Toplamlar -->
            <div class="lg:col-span-2 bg-slate-50 p-6 rounded-lg shadow-inner border border-slate-200">
                <h3 class="text-xl font-bold text-indigo-700 mb-4 border-b pb-2">Özet Tablosu</h3>
                <div class="space-y-3 text-gray-700">
                    <div class="flex justify-between">
                        <span class="font-medium">Ara Toplam (KDV Hariç):</span>
                        <span id="subtotalDisplay" class="font-bold text-lg">0.00 TL</span>
                    </div>
                    <div class="flex justify-between border-b pb-2">
                        <span class="font-medium">Toplam KDV:</span>
                        <span id="taxTotalDisplay" class="font-bold text-lg text-emerald-600">0.00 TL</span>
                    </div>
                    <div class="flex justify-between pt-2">
                        <span class="text-xl font-extrabold text-gray-900">GENEL TOPLAM:</span>
                        <span id="grandTotalDisplay" class="text-2xl font-extrabold text-indigo-600">0.00 TL</span>
                    </div>
                </div>
            </div>
        </section>


        <!-- 4. Panel: Fatura Önizleme Alanı (Görsel Kaydetme İçin) -->
        <section class="mt-12">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2 flex items-center">
                <svg class="w-6 h-6 mr-2 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17H7V7h10v10zM7 7V3h10v4M7 17v4h10v-4M12 3v4m0 13v4m-7-13h14"></path></svg>
                Belge Önizleme (PDF/Görsel İçin)
            </h2>
            
            <div id="invoicePreviewContainer" class="p-6 bg-white border-4 border-dashed border-gray-300 min-h-[600px] overflow-x-auto hide-scrollbar">
                
                <!-- Fatura Şablonu (Buraya dinamik olarak içerik yüklenecek) -->
                <div id="invoiceTemplate" class="w-[800px] mx-auto border border-gray-200 shadow-xl p-8 bg-white text-sm">
                    
                    <!-- Header -->
                    <header class="flex justify-between items-start border-b pb-4 mb-6">
                        <div>
                            <h1 class="text-4xl font-extrabold text-indigo-700 uppercase">FATURA</h1>
                            <p class="text-md text-gray-600 mt-1" id="previewInvoiceNumber">Fatura No: INV-2024-001</p>
                            <p class="text-md text-gray-600" id="previewInvoiceDate">Tarih: 12/05/2024</p>
                        </div>
                        <div class="text-right">
                            <h3 class="text-xl font-bold text-gray-800 mb-1" id="previewSenderName">[Şirketiniz]</h3>
                            <p class="text-xs text-gray-600" id="previewSenderAddress">[Adresiniz]</p>
                            <p class="text-xs text-gray-600" id="previewSenderTaxId">V.D. / V.No: [Vergi No]</p>
                        </div>
                    </header>

                    <!-- Alıcı -->
                    <div class="mb-8 border-b pb-4">
                        <p class="font-semibold text-gray-700 mb-1">MÜŞTERİ/ALICI:</p>
                        <p class="font-bold text-lg" id="previewRecipientName">[Müşteri Adı]</p>
                        <p class="text-sm text-gray-600" id="previewRecipientAddress">[Müşteri Adresi]</p>
                        <p class="text-sm text-gray-600" id="previewRecipientTaxId">V.D. / V.No: [Müşteri V.No]</p>
                    </div>

                    <!-- Kalemler Tablosu -->
                    <table class="w-full border-collapse mb-6">
                        <thead>
                            <tr class="bg-indigo-100 text-left text-xs uppercase tracking-wider">
                                <th class="p-3 border-b border-gray-300 w-1/2">Açıklama</th>
                                <th class="p-3 border-b border-gray-300 text-right w-1/6">Miktar</th>
                                <th class="p-3 border-b border-gray-300 text-right w-1/6">Birim Fiyat</th>
                                <th class="p-3 border-b border-gray-300 text-right w-1/6">Tutar (KDV Hariç)</th>
                            </tr>
                        </thead>
                        <tbody id="previewLineItems">
                            <!-- Dinamik içerik buraya -->
                            <tr class="border-b border-gray-100">
                                <td class="p-3">Örnek Hizmet Kalemi</td>
                                <td class="p-3 text-right">1</td>
                                <td class="p-3 text-right">1000.00 TL</td>
                                <td class="p-3 text-right font-semibold">1000.00 TL</td>
                            </tr>
                        </tbody>
                    </table>

                    <!-- Özet ve Notlar -->
                    <div class="flex justify-between mt-10">
                        <!-- Notlar Kısmı -->
                        <div class="w-1/2 pr-4">
                            <p class="font-semibold text-gray-700 mb-1">Ödeme Koşulları:</p>
                            <p class="text-xs italic text-gray-500 whitespace-pre-wrap" id="previewPaymentDetails">Banka Havalesi gereklidir.</p>
                            <p class="font-semibold text-gray-700 mt-4 mb-1">Ek Notlar:</p>
                            <p class="text-xs italic text-gray-500 whitespace-pre-wrap" id="previewNotes">Proje teslimatı tamamlandı.</p>
                        </div>

                        <!-- Özet Tablosu Kısmı -->
                        <div class="w-1/2 pl-4">
                            <div class="bg-gray-50 p-4 rounded-lg space-y-2 border border-gray-200">
                                <div class="flex justify-between">
                                    <span>Ara Toplam:</span>
                                    <span id="previewSubtotal" class="font-medium">0.00 TL</span>
                                </div>
                                <div class="flex justify-between text-emerald-600">
                                    <span id="previewVatLabel">KDV (%20):</span>
                                    <span id="previewTaxTotal" class="font-medium">0.00 TL</span>
                                </div>
                                <div class="flex justify-between pt-3 border-t border-gray-300">
                                    <span class="text-lg font-bold text-indigo-700">GENEL TOPLAM:</span>
                                    <span id="previewGrandTotal" class="text-xl font-extrabold text-indigo-700">0.00 TL</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Footer -->
                    <footer class="mt-12 pt-4 border-t text-center text-xs text-gray-500">
                        Bu belge, yasal bir fatura yerine geçmez, sadece önizleme ve raporlama amaçlıdır. ProInvoice tarafından oluşturulmuştur.
                    </footer>
                </div>

            </div>
        </section>

    </div>

    <script>
        // --- UTILITIES ---

        // Formatlama Fonksiyonu
        const formatCurrency = (amount) => {
            return parseFloat(amount).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ".") + " TL";
        };

        // --- LOCAL STORAGE & DATA MANAGEMENT ---

        const LOCAL_STORAGE_KEY = 'proInvoiceData';

        const defaultData = {
            senderName: 'Yazılım A.Ş.',
            senderAddress: 'Teknoloji Mah. No: 123, İstanbul',
            senderTaxId: '1234567890',
            senderEmail: 'info@yazilimasa.com',
            
            recipientName: 'Müşteri XYZ Ltd.',
            recipientContact: 'Ahmet Yılmaz',
            recipientTaxId: '0987654321',
            recipientAddress: 'İş Merkezi No: 5, Ankara',
            
            invoiceNumber: 'INV-2024-005',
            invoiceDate: new Date().toISOString().split('T')[0],
            dueDate: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0], // 7 gün sonrası
            taxRate: '0.20',
            
            lineItems: [
                { description: 'Kurumsal Web Sitesi Geliştirme (Faz 1)', quantity: 1, unitPrice: 15000.00 },
                { description: 'Aylık Bakım ve Destek Sözleşmesi (3 Ay)', quantity: 3, unitPrice: 500.00 }
            ],
            notes: 'Ödeme, fatura tarihinden itibaren 15 gün içerisinde yapılmalıdır.',
            paymentDetails: 'Garanti Bankası TR1234567890123456789012345'
        };

        function loadData() {
            const storedData = localStorage.getItem(LOCAL_STORAGE_KEY);
            if (storedData) {
                return JSON.parse(storedData);
            }
            return defaultData;
        }

        function saveData() {
            const data = {
                senderName: document.getElementById('senderName').value,
                senderAddress: document.getElementById('senderAddress').value,
                senderTaxId: document.getElementById('senderTaxId').value,
                senderEmail: document.getElementById('senderEmail').value,

                recipientName: document.getElementById('recipientName').value,
                recipientContact: document.getElementById('recipientContact').value,
                recipientTaxId: document.getElementById('recipientTaxId').value,
                recipientAddress: document.getElementById('recipientAddress').value,

                invoiceNumber: document.getElementById('invoiceNumber').value,
                invoiceDate: document.getElementById('invoiceDate').value,
                dueDate: document.getElementById('dueDate').value,
                taxRate: document.getElementById('taxRate').value,
                
                lineItems: getLineItemsFromUI(),
                notes: document.getElementById('notes').value,
                paymentDetails: document.getElementById('paymentDetails').value,
            };
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(data));
            alert('Verileriniz tarayıcınıza kaydedildi!');
        }

        // --- UI RENDERING & INPUT HANDLING ---

        let itemIdCounter = 0; // Benzersiz ID ataması için

        function getLineItemsFromUI() {
            const items = [];
            document.querySelectorAll('.line-item-row').forEach(row => {
                items.push({
                    id: row.dataset.itemId,
                    description: row.querySelector('.item-description').value,
                    quantity: parseFloat(row.querySelector('.item-quantity').value) || 0,
                    unitPrice: parseFloat(row.querySelector('.item-unitprice').value) || 0,
                });
            });
            return items;
        }

        function createLineItemRow(item = { id: Date.now() + Math.random(), description: '', quantity: 1, unitPrice: 0.00 }) {
            itemIdCounter++;
            const tr = document.createElement('div');
            tr.className = 'line-item-row grid grid-cols-12 gap-3 p-3 border border-gray-200 rounded-lg bg-white shadow-sm items-center';
            tr.setAttribute('data-item-id', item.id);
            
            tr.innerHTML = `
                <div class="col-span-12 lg:col-span-5">
                    <input type="text" class="item-description w-full p-2 border border-gray-300 rounded-md focus:ring-emerald-500 focus:border-emerald-500 placeholder-gray-400 text-sm" placeholder="Hizmet Açıklaması" value="${item.description}">
                </div>
                <div class="col-span-4 lg:col-span-2">
                    <input type="number" min="0" step="1" class="item-quantity w-full p-2 border border-gray-300 rounded-md focus:ring-emerald-500 focus:border-emerald-500 text-right placeholder-gray-400 text-sm" placeholder="Adet" value="${item.quantity}">
                </div>
                <div class="col-span-4 lg:col-span-2">
                    <input type="number" min="0" step="0.01" class="item-unitprice w-full p-2 border border-gray-300 rounded-md focus:ring-emerald-500 focus:border-emerald-500 text-right placeholder-gray-400 text-sm" placeholder="Birim Fiyat" value="${item.unitPrice > 0 ? item.unitPrice : ''}">
                </div>
                <div class="col-span-4 lg:col-span-2 text-right">
                    <span class="item-total-display font-semibold text-gray-800 text-base">0.00 TL</span>
                </div>
                <div class="col-span-12 lg:col-span-1 flex justify-end">
                    <button type="button" class="remove-item text-red-500 hover:text-red-700 p-1 rounded-full transition">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    </button>
                </div>
            `;
            
            // Olay dinleyicilerini ekle
            tr.querySelectorAll('input').forEach(input => {
                input.addEventListener('input', calculateTotals);
            });
            tr.querySelector('.remove-item').addEventListener('click', () => {
                tr.remove();
                calculateTotals();
            });

            document.getElementById('lineItemsContainer').appendChild(tr);
            calculateTotals(); // Yeni eklenen satırın toplamını hesapla (varsa)
        }

        function renderAllLineItems(items) {
            document.getElementById('lineItemsContainer').innerHTML = '';
            if (items.length === 0) {
                // Eğer kayıtlı kalem yoksa varsayılan bir boş satır ekle
                createLineItemRow({ description: '', quantity: 1, unitPrice: 0.00 });
            } else {
                items.forEach(item => createLineItemRow(item));
            }
        }

        // --- CORE CALCULATION LOGIC ---

        function calculateTotals() {
            const items = getLineItemsFromUI();
            let subtotal = 0;
            const taxRate = parseFloat(document.getElementById('taxRate').value);

            items.forEach(item => {
                const quantity = item.quantity || 0;
                const unitPrice = item.unitPrice || 0;
                const total = quantity * unitPrice;
                subtotal += total;

                // Satır içi toplamı güncelle (Önizleme için değil, inputları güncellemek için)
                const rowElement = document.querySelector(`.line-item-row[data-item-id="${item.id}"]`);
                if (rowElement) {
                    rowElement.querySelector('.item-total-display').textContent = formatCurrency(total);
                }
            });

            const taxTotal = subtotal * taxRate;
            const grandTotal = subtotal + taxTotal;

            // Ana Özet Güncelleme (Input Paneli)
            document.getElementById('subtotalDisplay').textContent = formatCurrency(subtotal);
            document.getElementById('taxTotalDisplay').textContent = formatCurrency(taxTotal);
            document.getElementById('grandTotalDisplay').textContent = formatCurrency(grandTotal);
            
            // Önizleme Güncelleme
            updatePreview(subtotal, taxTotal, grandTotal, taxRate);
        }

        function updatePreview(subtotal, taxTotal, grandTotal, taxRate) {
            // 1. Firma ve Belge Bilgilerini Yükle
            document.getElementById('previewInvoiceNumber').textContent = `Fatura No: ${document.getElementById('invoiceNumber').value || '...'}`;
            document.getElementById('previewInvoiceDate').textContent = `Tarih: ${document.getElementById('invoiceDate').value || '...'}`;
            document.getElementById('previewSenderName').textContent = document.getElementById('senderName').value || '[Şirketiniz]';
            document.getElementById('previewSenderAddress').textContent = document.getElementById('senderAddress').value || '[Adresiniz]';
            document.getElementById('previewSenderTaxId').textContent = `V.D. / V.No: ${document.getElementById('senderTaxId').value || '[Vergi No]'}`;
            
            document.getElementById('previewRecipientName').textContent = document.getElementById('recipientName').value || '[Müşteri Adı]';
            document.getElementById('previewRecipientAddress').textContent = document.getElementById('recipientAddress').value || '[Müşteri Adresi]';
            document.getElementById('previewRecipientTaxId').textContent = `V.D. / V.No: ${document.getElementById('recipientTaxId').value || '[Müşteri V.No]'}`;
            
            document.getElementById('previewNotes').textContent = document.getElementById('notes').value || 'Ek not yok.';
            document.getElementById('previewPaymentDetails').textContent = document.getElementById('paymentDetails').value || 'Ödeme bilgisi girilmedi.';

            // KDV Etiketi ve Oranı
            const ratePercentage = (taxRate * 100).toFixed(0);
            document.getElementById('previewVatLabel').textContent = `KDV (%${ratePercentage}):`;

            // 2. Kalem Tablosu Yükle
            const previewItemsBody = document.getElementById('previewLineItems');
            previewItemsBody.innerHTML = ''; // Eski verileri temizle

            const items = getLineItemsFromUI();
            items.forEach(item => {
                const total = item.quantity * item.unitPrice;
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-100 hover:bg-gray-50';
                row.innerHTML = `
                    <td class="p-3 whitespace-pre-wrap">${item.description || 'Tanımsız Kalem'}</td>
                    <td class="p-3 text-right">${item.quantity || 0}</td>
                    <td class="p-3 text-right">${formatCurrency(item.unitPrice || 0)}</td>
                    <td class="p-3 text-right font-semibold">${formatCurrency(total)}</td>
                `;
                previewItemsBody.appendChild(row);
            });
            
            // Eğer hiç kalem yoksa (varsayılan boş satır hariç)
            if (items.length === 0) {
                previewItemsBody.innerHTML = `<tr><td colspan="4" class="p-3 text-center text-gray-500 italic">Henüz hiç kalem eklenmedi.</td></tr>`;
            }

            // 3. Özet Yükle
            document.getElementById('previewSubtotal').textContent = formatCurrency(subtotal);
            document.getElementById('previewTaxTotal').textContent = formatCurrency(taxTotal);
            document.getElementById('previewGrandTotal').textContent = formatCurrency(grandTotal);
        }


        // --- INITIALIZATION & EVENT BINDING ---

        function initializeApp() {
            const loadedData = loadData();

            // Input alanlarını doldur (LocalStorage'dan gelenlerle veya default ile)
            document.getElementById('senderName').value = loadedData.senderName || '';
            document.getElementById('senderAddress').value = loadedData.senderAddress || '';
            document.getElementById('senderTaxId').value = loadedData.senderTaxId || '';
            document.getElementById('senderEmail').value = loadedData.senderEmail || '';
            
            document.getElementById('recipientName').value = loadedData.recipientName || '';
            document.getElementById('recipientContact').value = loadedData.recipientContact || '';
            document.getElementById('recipientTaxId').value = loadedData.recipientTaxId || '';
            document.getElementById('recipientAddress').value = loadedData.recipientAddress || '';

            document.getElementById('invoiceNumber').value = loadedData.invoiceNumber || '';
            document.getElementById('invoiceDate').value = loadedData.invoiceDate || '';
            document.getElementById('dueDate').value = loadedData.dueDate || '';
            document.getElementById('taxRate').value = loadedData.taxRate || '0.20';
            document.getElementById('notes').value = loadedData.notes || '';
            document.getElementById('paymentDetails').value = loadedData.paymentDetails || '';

            renderAllLineItems(loadedData.lineItems);
            
            // Tüm temel input değişikliklerini dinle
            document.querySelectorAll('#app input, #app select, #app textarea').forEach(element => {
                element.addEventListener('input', calculateTotals);
            });
            
            // Dinamik Buton Ekleme
            document.getElementById('addLineItem').addEventListener('click', () => {
                createLineItemRow({ description: '', quantity: 1, unitPrice: 0.00 });
                calculateTotals();
            });

            // Kaydetme İşlemi
            document.getElementById('btnSave').addEventListener('click', saveData);

            // PDF Dışa Aktarma (Basit Tarayıcı Print Fonksiyonu Kullanımı)
            document.getElementById('btnExportPDF').addEventListener('click', () => {
                // Sadece önizleme alanını yazdırma/PDF yapma işlemini tetikle
                const invoiceContent = document.getElementById('invoiceTemplate');
                
                // Yazdırma öncesi hazırlık (CSS kısıtlaması: sadece şablon yazdırılmalı)
                const printWindow = window.open('', '_blank');
                printWindow.document.write(`
                    <html>
                    <head>
                        <title>Fatura - ${document.getElementById('invoiceNumber').value || 'Yeni'}</title>
                        <style>
                            /* Tailwind'i ve özel stilleri buraya gömüyoruz */
                            @page {
                                size: A4 landscape; /* Genellikle Faturalar yatay veya A4 dikey basılır */
                                margin: 0;
                            }
                            body {
                                background-color: #ffffff;
                                margin: 0;
                                padding: 0;
                            }
                            /* Sadece yazdırma için gerekli olan temel stilin bir kısmını kopyala */
                            #invoiceTemplate {
                                box-shadow: none;
                                border: none !important;
                                margin: 0 !important;
                                padding: 30px !important;
                                width: 100% !important;
                                font-family: Arial, sans-serif;
                            }
                            .text-xs { font-size: 10px !important; }
                            .text-sm { font-size: 12px !important; }
                            .text-md { font-size: 14px !important; }
                            .text-lg { font-size: 16px !important; }
                            .text-xl { font-size: 20px !important; }
                            .text-2xl { font-size: 24px !important; }
                            .font-bold { font-weight: 700; }
                            .font-extrabold { font-weight: 900; }
                            table, th, td { border-collapse: collapse; }
                        </style>
                    </head>
                    <body>
                        ${invoiceContent.outerHTML}
                    </body>
                    </html>
                `);
                printWindow.document.close();
                printWindow.print();
            });
            
            // İlk çalıştırmada hesaplamaları yap ve önizlemeyi göster
            calculateTotals();
        }

        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>

</body>
</html>