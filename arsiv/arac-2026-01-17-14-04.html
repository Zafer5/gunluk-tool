<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro-InvoiceFlow: Kurumsal Fatura ve Teklif Oluşturucu</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Kurumsal Tailwind Paleti */
        :root {
            --color-primary: #4f46e5; /* Indigo 600 */
            --color-secondary: #10b981; /* Emerald 500 */
            --color-background: #f9fafb; /* Gray 50 */
            --color-card: #ffffff;
            --color-text: #1f2937; /* Gray 800 */
        }

        body {
            background-color: var(--color-background);
            font-family: 'Inter', sans-serif;
        }

        .btn-primary {
            background-color: var(--color-primary);
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: #4338ca; /* Indigo 700 */
        }
        .btn-secondary {
            background-color: var(--color-secondary);
            transition: background-color 0.2s;
        }
        .btn-secondary:hover {
            background-color: #059669; /* Emerald 600 */
        }

        /* PDF Önizleme Stili */
        #invoice-preview {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            border: 1px solid #e5e7eb;
            background-color: var(--color-card);
        }
        .input-field {
            border: 1px solid #d1d5db; /* Gray 300 */
        }
        .input-field:focus {
            border-color: var(--color-primary);
            box-shadow: 0 0 0 1px var(--color-primary);
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>

    <div class="min-h-screen p-4 md:p-8">
        <header class="mb-8 border-b pb-4 flex justify-between items-center">
            <h1 class="text-3xl font-extrabold text-gray-900 flex items-center">
                <svg class="w-8 h-8 mr-2 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M12 14h.01"></path></svg>
                Pro-InvoiceFlow
            </h1>
            <div class="flex space-x-3">
                <button id="save-btn" class="btn-primary text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:shadow-lg flex items-center text-sm">
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-6 0V5a2 2 0 012-2h2a2 2 0 012 2v2"></path></svg>
                    PDF Olarak Kaydet
                </button>
                <button id="copy-btn" class="btn-secondary text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:shadow-lg flex items-center text-sm">
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1m-8-8h2m-2 4h2m-2 4h2m8-12v2m0 4v2m0 4v2m0-12a2 2 0 00-2-2h-2a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2V7z"></path></svg>
                    Verileri Kopyala
                </button>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
            
            <!-- SOL SÜTUN: GİRİŞ FORMLARI (2/5) -->
            <div class="lg:col-span-2 space-y-6">
                <h2 class="text-xl font-bold text-gray-700 mb-4 border-b pb-2">Fatura Detayları (Ayarlar)</h2>
                
                <!-- Şirket Bilgileri -->
                <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100">
                    <h3 class="text-lg font-semibold text-indigo-600 mb-3 flex items-center">
                         <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0h6"></path></svg>
                        Gönderen (Sizin) Bilgileriniz
                    </h3>
                    <div class="space-y-3">
                        <input type="text" id="senderName" placeholder="Şirket Adı / Freelancer Adı" class="w-full p-2 rounded-lg input-field text-sm">
                        <input type="text" id="senderAddress" placeholder="Adres Satırı 1" class="w-full p-2 rounded-lg input-field text-sm">
                        <input type="email" id="senderEmail" placeholder="E-posta Adresi" class="w-full p-2 rounded-lg input-field text-sm">
                        <input type="text" id="senderTaxId" placeholder="Vergi Dairesi / ID No" class="w-full p-2 rounded-lg input-field text-sm">
                    </div>
                </div>

                <!-- Müşteri Bilgileri -->
                <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100">
                    <h3 class="text-lg font-semibold text-indigo-600 mb-3 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                        Alıcı (Müşteri) Bilgileri
                    </h3>
                    <div class="space-y-3">
                        <input type="text" id="recipientName" placeholder="Müşteri Şirket Adı" class="w-full p-2 rounded-lg input-field text-sm">
                        <input type="text" id="recipientContact" placeholder="Müşteri İlgili Kişi" class="w-full p-2 rounded-lg input-field text-sm">
                        <input type="text" id="recipientAddress" placeholder="Müşteri Adresi" class="w-full p-2 rounded-lg input-field text-sm">
                    </div>
                </div>
                
                <!-- Fatura Ayarları -->
                <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100">
                    <h3 class="text-lg font-semibold text-indigo-600 mb-3 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                        Belge Numaraları
                    </h3>
                    <div class="grid grid-cols-2 gap-3">
                        <input type="text" id="invoiceNumber" placeholder="Fatura No: INV-0001" class="p-2 rounded-lg input-field text-sm">
                        <input type="date" id="invoiceDate" class="p-2 rounded-lg input-field text-sm">
                        <input type="text" id="poNumber" placeholder="Teklif/Sipariş No (Opsiyonel)" class="p-2 rounded-lg input-field text-sm col-span-2">
                    </div>
                </div>

            </div>

            <!-- SAĞ SÜTUN: ÖNİZLEME ALANI (3/5) -->
            <div class="lg:col-span-3">
                <h2 class="text-xl font-bold text-gray-700 mb-4 border-b pb-2">Fatura Önizleme</h2>

                <!-- Ayarlar ve Logo -->
                <div class="bg-white p-4 mb-4 rounded-xl shadow flex justify-between items-center">
                    <div class="flex items-center space-x-4">
                        <label for="vatRate" class="text-sm font-medium text-gray-600">KDV Oranı (%):</label>
                        <input type="number" id="vatRate" value="20" min="0" max="100" step="0.1" class="w-20 p-1 border rounded-lg text-center text-sm">
                    </div>
                    <div class="flex items-center space-x-2">
                        <label for="logoUpload" class="text-sm font-medium text-gray-600">Logo Yükle:</label>
                        <input type="file" id="logoUpload" accept="image/*" class="text-xs hidden">
                        <button id="uploadTrigger" class="btn-secondary text-white text-xs py-1 px-3 rounded-lg">Gözat</button>
                    </div>
                </div>

                <!-- Önizleme Alanı -->
                <div id="invoice-preview" class="p-8 rounded-xl min-h-[800px] text-gray-800">
                    <!-- Logo Alanı (SVG Placeholder) -->
                    <div id="previewLogoContainer" class="mb-6 flex justify-end">
                        <svg id="defaultLogo" class="w-24 h-24 text-indigo-500 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h.01M12 18h.01M19 3H5a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2V5a2 2 0 00-2-2z"></path></svg>
                        <img id="uploadedLogo" src="" alt="Logo" class="hidden max-w-[120px] max-h-[120px] object-contain">
                    </div>
                    
                    <!-- Başlık ve Tarih -->
                    <div class="flex justify-between mb-10 border-b pb-4">
                        <div>
                            <h2 class="text-4xl font-extrabold text-indigo-700">FATURA</h2>
                            <p class="text-sm mt-1 text-gray-500">Fatura No: <span id="dispInvoiceNumber" class="font-semibold text-gray-800">-</span></p>
                            <p class="text-sm text-gray-500">Tarih: <span id="dispInvoiceDate" class="font-semibold text-gray-800">-</span></p>
                        </div>
                        <div class="text-right">
                            <p class="text-xs text-gray-500">Gönderen:</p>
                            <p id="dispSenderName" class="font-bold text-base">Adınız Buraya</p>
                            <p id="dispSenderAddress" class="text-sm">Adresiniz</p>
                            <p id="dispSenderEmail" class="text-sm text-indigo-500">eposta@sirket.com</p>
                            <p id="dispSenderTaxId" class="text-xs mt-1">Vergi No: -</p>
                        </div>
                    </div>

                    <!-- Alıcı Bilgileri -->
                    <div class="mb-10 p-4 bg-gray-50 rounded-lg border border-gray-200">
                        <p class="text-sm font-semibold text-gray-600 mb-1">FATURA KESİLECEK KURULUŞ:</p>
                        <p id="dispRecipientName" class="font-bold text-lg text-gray-900">Müşteri A.Ş.</p>
                        <p id="dispRecipientContact" class="text-sm">İlgili: -</p>
                        <p id="dispRecipientAddress" class="text-sm">Müşteri Adresi</p>
                    </div>

                    <!-- Ürün Tablosu -->
                    <table class="w-full border-collapse mb-6">
                        <thead>
                            <tr class="bg-indigo-50 text-left text-sm uppercase text-indigo-700">
                                <th class="p-3 border-b border-indigo-200 w-1/2">Açıklama</th>
                                <th class="p-3 border-b border-indigo-200 text-right">Miktar</th>
                                <th class="p-3 border-b border-indigo-200 text-right">Birim Fiyat</th>
                                <th class="p-3 border-b border-indigo-200 text-right">Toplam</th>
                            </tr>
                        </thead>
                        <tbody id="invoice-items-body">
                            <!-- JS ile eklenecek satırlar -->
                            <tr class="item-row" data-id="default1">
                                <td class="p-3 border-b border-gray-100">Profesyonel Yazılım Geliştirme Hizmeti</td>
                                <td class="p-3 border-b border-gray-100 text-right">1</td>
                                <td class="p-3 border-b border-gray-100 text-right">2,500.00 TL</td>
                                <td class="p-3 border-b border-gray-100 text-right font-medium">2,500.00 TL</td>
                            </tr>
                            <tr class="item-row" data-id="default2">
                                <td class="p-3 border-b border-gray-100">Aylık Lisanslama ve Destek (3 Ay)</td>
                                <td class="p-3 border-b border-gray-100 text-right">3</td>
                                <td class="p-3 border-b border-gray-100 text-right">500.00 TL</td>
                                <td class="p-3 border-b border-gray-100 text-right font-medium">1,500.00 TL</td>
                            </tr>
                        </tbody>
                    </table>

                    <!-- Özet -->
                    <div class="flex justify-end">
                        <div class="w-full md:w-1/2 space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Ara Toplam:</span>
                                <span id="subtotal" class="font-medium">0.00 TL</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600 flex items-center">KDV (<span id="vatPercentageDisplay">20</span>%):</span>
                                <span id="vatAmount" class="font-medium">0.00 TL</span>
                            </div>
                            <div class="flex justify-between border-t pt-2 border-gray-300">
                                <span class="text-lg font-bold text-indigo-700">GENEL TOPLAM:</span>
                                <span id="totalAmount" class="text-xl font-extrabold text-emerald-600">0.00 TL</span>
                            </div>
                        </div>
                    </div>

                    <!-- Notlar -->
                    <div class="mt-12 p-4 bg-yellow-50 border-l-4 border-yellow-400 text-sm text-gray-700 rounded-r-lg">
                        <p class="font-semibold mb-1">Ödeme Bilgileri / Notlar:</p>
                        <p id="invoiceNotes">Lütfen ödemenizi 7 gün içinde gerçekleştiriniz. Hesap IBAN: TR1234567890123456789012</p>
                    </div>

                </div>
                
                <!-- Satır Ekleme Yönetimi -->
                <div class="mt-6 bg-white p-6 rounded-xl shadow-lg border border-gray-100">
                    <h3 class="text-lg font-semibold text-emerald-600 mb-3 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                        Satır Ekle/Düzenle
                    </h3>
                    
                    <div id="item-input-area" class="space-y-4 mb-4 p-3 border rounded-lg bg-gray-50">
                        <div class="grid grid-cols-5 gap-2 text-xs font-semibold text-gray-600">
                            <div class="col-span-2">Açıklama</div>
                            <div>Miktar</div>
                            <div>Birim Fiyat</div>
                            <div>İşlem</div>
                        </div>
                        <!-- Dinamik inputlar buraya eklenecek -->
                    </div>

                    <button id="addItemBtn" class="btn-secondary text-white font-semibold py-2 px-4 rounded-lg text-sm w-full flex items-center justify-center">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                        Yeni Satır Ekle
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const DOMAIN = 'Pro-InvoiceFlow';
            const STORAGE_KEY = `${DOMAIN}_InvoiceData`;

            // 1. DOM Elemanları
            const elements = {
                // Input Alanları
                senderName: document.getElementById('senderName'),
                senderAddress: document.getElementById('senderAddress'),
                senderEmail: document.getElementById('senderEmail'),
                senderTaxId: document.getElementById('senderTaxId'),
                recipientName: document.getElementById('recipientName'),
                recipientContact: document.getElementById('recipientContact'),
                recipientAddress: document.getElementById('recipientAddress'),
                invoiceNumber: document.getElementById('invoiceNumber'),
                invoiceDate: document.getElementById('invoiceDate'),
                poNumber: document.getElementById('poNumber'),
                vatRateInput: document.getElementById('vatRate'),
                invoiceNotes: document.getElementById('invoiceNotes'),
                
                // Önizleme Alanları
                itemBody: document.getElementById('invoice-items-body'),
                subtotalDisp: document.getElementById('subtotal'),
                vatAmountDisp: document.getElementById('vatAmount'),
                totalAmountDisp: document.getElementById('totalAmount'),
                vatPercentageDisplay: document.getElementById('vatPercentageDisplay'),

                // Logo
                uploadTrigger: document.getElementById('uploadTrigger'),
                logoUpload: document.getElementById('logoUpload'),
                uploadedLogo: document.getElementById('uploadedLogo'),
                defaultLogo: document.getElementById('defaultLogo'),

                // Butonlar
                addItemBtn: document.getElementById('addItemBtn'),
                saveBtn: document.getElementById('save-btn'),
                copyBtn: document.getElementById('copy-btn'),
                
                // Önizleme Alanı (PDF için)
                invoicePreview: document.getElementById('invoice-preview'),
            };

            let lineItemIdCounter = 0;
            let currentInvoiceItems = [];

            // --- UTILITY FONKSİYONLARI ---

            const formatCurrency = (amount) => {
                return new Intl.NumberFormat('tr-TR', { 
                    minimumFractionDigits: 2, 
                    maximumFractionDigits: 2 
                }).format(amount) + " TL";
            };

            // --- LOCAL STORAGE VE VERİ YÜKLEME ---

            const loadData = () => {
                const savedData = localStorage.getItem(STORAGE_KEY);
                if (savedData) {
                    const data = JSON.parse(savedData);
                    
                    // Genel Ayarları Yükle
                    elements.senderName.value = data.senderName || '';
                    elements.senderAddress.value = data.senderAddress || '';
                    elements.senderEmail.value = data.senderEmail || '';
                    elements.senderTaxId.value = data.senderTaxId || '';
                    elements.recipientName.value = data.recipientName || '';
                    elements.recipientContact.value = data.recipientContact || '';
                    elements.recipientAddress.value = data.recipientAddress || '';
                    elements.invoiceNumber.value = data.invoiceNumber || '';
                    elements.invoiceDate.value = data.invoiceDate || '';
                    elements.poNumber.value = data.poNumber || '';
                    elements.vatRateInput.value = data.vatRate || '20';
                    elements.invoiceNotes.value = data.invoiceNotes || 'Lütfen ödemenizi 7 gün içinde gerçekleştiriniz. Hesap IBAN: TR1234567890123456789012';

                    // Satırları Yükle
                    if (data.items && data.items.length > 0) {
                        currentInvoiceItems = data.items;
                        lineItemIdCounter = data.nextItemId || 0;
                    } else {
                        // Boş başlangıç için varsayılan satırlar (LocalStorage boşsa)
                        currentInvoiceItems = [
                            { id: getNextItemId(), desc: "Profesyonel Yazılım Geliştirme Hizmeti", qty: 1, unitPrice: 2500.00 },
                            { id: getNextItemId(), desc: "Aylık Lisanslama ve Destek (3 Ay)", qty: 3, unitPrice: 500.00 }
                        ];
                    }

                    // Logo yükleme durumu (Basitlik için sadece placeholder'ı tutuyoruz)
                    if (data.logoData) {
                        elements.uploadedLogo.src = data.logoData;
                        elements.uploadedLogo.classList.remove('hidden');
                        elements.defaultLogo.classList.add('hidden');
                    }
                    
                } else {
                    // İlk kez açılışta boş veya varsayılan ayarlar
                    elements.invoiceDate.value = new Date().toISOString().substring(0, 10);
                    elements.vatRateInput.value = 20;
                    elements.invoiceNotes.value = 'Lütfen ödemenizi 7 gün içinde gerçekleştiriniz. Hesap IBAN: TR1234567890123456789012';
                    currentInvoiceItems = [
                        { id: getNextItemId(), desc: "Profesyonel Yazılım Geliştirme Hizmeti", qty: 1, unitPrice: 2500.00 },
                        { id: getNextItemId(), desc: "Aylık Lisanslama ve Destek (3 Ay)", qty: 3, unitPrice: 500.00 }
                    ];
                }
                
                renderItems();
                updateInvoicePreview();
            };

            const saveData = () => {
                const logoData = elements.uploadedLogo.src && elements.uploadedLogo.src.startsWith('data:image') ? elements.uploadedLogo.src : null;
                
                const dataToSave = {
                    senderName: elements.senderName.value,
                    senderAddress: elements.senderAddress.value,
                    senderEmail: elements.senderEmail.value,
                    senderTaxId: elements.senderTaxId.value,
                    recipientName: elements.recipientName.value,
                    recipientContact: elements.recipientContact.value,
                    recipientAddress: elements.recipientAddress.value,
                    invoiceNumber: elements.invoiceNumber.value,
                    invoiceDate: elements.invoiceDate.value,
                    poNumber: elements.poNumber.value,
                    vatRate: elements.vatRateInput.value,
                    invoiceNotes: elements.invoiceNotes.value,
                    items: currentInvoiceItems,
                    nextItemId: lineItemIdCounter,
                    logoData: logoData
                };
                localStorage.setItem(STORAGE_KEY, JSON.stringify(dataToSave));
            };

            // --- İŞLEVSEL GÜNCELLEMELER ---
            
            const getNextItemId = () => {
                lineItemIdCounter++;
                return `item_${Date.now()}_${lineItemIdCounter}`;
            };

            const calculateTotals = () => {
                let subtotal = 0;
                currentInvoiceItems.forEach(item => {
                    subtotal += (parseFloat(item.qty) || 0) * (parseFloat(item.unitPrice) || 0);
                });

                const vatRate = parseFloat(elements.vatRateInput.value) || 0;
                const vatAmount = subtotal * (vatRate / 100);
                const total = subtotal + vatAmount;
                
                return { subtotal, vatAmount, total, vatRate };
            };

            const updateInvoicePreview = () => {
                const { subtotal, vatAmount, total, vatRate } = calculateTotals();

                // 1. Metin Alanları
                document.getElementById('dispSenderName').textContent = elements.senderName.value || 'Şirketiniz Adı';
                document.getElementById('dispSenderAddress').textContent = elements.senderAddress.value || 'Adresiniz Burada';
                document.getElementById('dispSenderEmail').textContent = elements.senderEmail.value || 'kurumsal@email.com';
                document.getElementById('dispSenderTaxId').textContent = elements.senderTaxId.value ? `Vergi No: ${elements.senderTaxId.value}` : 'Vergi No: Yok';
                
                document.getElementById('dispRecipientName').textContent = elements.recipientName.value || 'Müşteri A.Ş.';
                document.getElementById('dispRecipientContact').textContent = elements.recipientContact.value || '-';
                document.getElementById('dispRecipientAddress').textContent = elements.recipientAddress.value || 'Müşteri Adresi';

                document.getElementById('dispInvoiceNumber').textContent = elements.invoiceNumber.value || '-';
                document.getElementById('dispInvoiceDate').textContent = elements.invoiceDate.value || '-';
                document.getElementById('invoiceNotes').textContent = elements.invoiceNotes.value || 'Ödeme Notları';


                // 2. Hesaplamalar
                elements.subtotalDisp.textContent = formatCurrency(subtotal);
                elements.vatAmountDisp.textContent = formatCurrency(vatAmount);
                elements.totalAmountDisp.textContent = formatCurrency(total);
                elements.vatPercentageDisplay.textContent = vatRate.toFixed(2).replace(/\.?0+$/, ''); // Gereksiz .00'ları kaldırır
            };

            // --- SATIR YÖNETİMİ ---

            const renderItemInputRow = (item) => {
                const div = document.createElement('div');
                div.className = 'grid grid-cols-5 gap-2 text-sm items-center';
                div.dataset.itemId = item.id;

                div.innerHTML = `
                    <input type="text" value="${item.desc}" data-type="desc" placeholder="Açıklama" 
                        class="col-span-2 p-2 rounded-lg input-field">
                    <input type="number" value="${item.qty}" data-type="qty" placeholder="Miktar" min="0" step="1"
                        class="p-2 rounded-lg input-field text-right">
                    <input type="number" value="${item.unitPrice.toFixed(2)}" data-type="price" placeholder="Fiyat" min="0.01" step="0.01"
                        class="p-2 rounded-lg input-field text-right">
                    <div class="flex space-x-1">
                        <button class="update-btn bg-emerald-500 text-white p-2 rounded-md hover:bg-emerald-600 transition" title="Kaydet">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                        </button>
                        <button class="delete-btn bg-red-500 text-white p-2 rounded-md hover:bg-red-600 transition" title="Sil">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    </div>
                `;
                elements.itemBody.appendChild(div);

                // ÖNİZLEME SATIRINI OLUŞTUR
                const previewRow = document.createElement('tr');
                previewRow.className = 'item-row';
                previewRow.dataset.id = item.id;
                previewRow.innerHTML = `
                    <td class="p-3 border-b border-gray-100">${item.desc}</td>
                    <td class="p-3 border-b border-gray-100 text-right">${item.qty}</td>
                    <td class="p-3 border-b border-gray-100 text-right">${formatCurrency(item.unitPrice)}</td>
                    <td class="p-3 border-b border-gray-100 text-right font-medium">${formatCurrency(item.qty * item.unitPrice)}</td>
                `;
                elements.itemBody.appendChild(previewRow);
            };
            
            const renderItems = () => {
                elements.itemBody.innerHTML = ''; // Temizle
                if (currentInvoiceItems.length === 0) {
                    // Boş olduğunda bilgilendirme
                    elements.itemBody.innerHTML = `
                        <tr>
                            <td colspan="4" class="p-4 text-center text-gray-500 italic bg-gray-50">
                                Henüz fatura kalemi eklenmedi. Lütfen yukarıdan ekleme yapın.
                            </td>
                        </tr>
                    `;
                }
                currentInvoiceItems.forEach(item => {
                    renderItemInputRow(item);
                });
            };
            
            const updateItem = (itemId, newDesc, newQty, newPrice) => {
                const itemIndex = currentInvoiceItems.findIndex(item => item.id === itemId);
                if (itemIndex !== -1) {
                    currentInvoiceItems[itemIndex].desc = newDesc;
                    currentInvoiceItems[itemIndex].qty = parseFloat(newQty) || 0;
                    currentInvoiceItems[itemIndex].unitPrice = parseFloat(newPrice) || 0;
                    
                    // DOM'u ve veriyi güncelle
                    renderItems(); 
                    updateInvoicePreview();
                    saveData();
                }
            };

            const deleteItem = (itemId) => {
                currentInvoiceItems = currentInvoiceItems.filter(item => item.id !== itemId);
                
                // DOM'u güncelle
                renderItems(); 
                updateInvoicePreview();
                saveData();
            };

            const handleAddItem = () => {
                const newItemId = getNextItemId();
                const newItem = {
                    id: newItemId,
                    desc: 'Yeni Hizmet/Ürün',
                    qty: 1,
                    unitPrice: 100.00
                };
                currentInvoiceItems.push(newItem);
                renderItemInputRow(newItem);
                updateInvoicePreview();
                saveData();
            };

            // --- EVENT HANDLER'LAR ---
            
            const setupEventListeners = () => {
                // 1. Tüm input alanlarından veri girişi (Anlık güncelleme)
                const inputSelectors = [
                    elements.senderName, elements.senderAddress, elements.senderEmail, elements.senderTaxId,
                    elements.recipientName, elements.recipientContact, elements.recipientAddress,
                    elements.invoiceNumber, elements.invoiceDate, elements.poNumber, elements.vatRateInput,
                    elements.invoiceNotes
                ];

                inputSelectors.forEach(el => {
                    if (el) {
                        el.addEventListener('input', () => {
                            updateInvoicePreview();
                            saveData();
                        });
                    }
                });

                // 2. Satır Ekleme
                elements.addItemBtn.addEventListener('click', handleAddItem);

                // 3. Dinamik Satır İşlemleri (Delegation)
                document.getElementById('item-input-area').addEventListener('click', (e) => {
                    const target = e.target.closest('button');
                    if (!target) return;

                    const row = target.closest('.grid[data-item-id]');
                    if (!row) return;
                    
                    const itemId = row.dataset.itemId;

                    if (target.classList.contains('update-btn')) {
                        const inputs = row.querySelectorAll('input');
                        const desc = inputs[0].value;
                        const qty = inputs[1].value;
                        const price = inputs[2].value;
                        
                        updateItem(itemId, desc, qty, price);
                    } else if (target.classList.contains('delete-btn')) {
                        if (confirm("Bu satırı silmek istediğinizden emin misiniz?")) {
                            deleteItem(itemId);
                        }
                    }
                });
                
                // Güncelleme yapıldığında otomatik olarak satırları kaydetme (input'tan çıkınca)
                document.getElementById('item-input-area').addEventListener('change', (e) => {
                    const input = e.target;
                    if (input.tagName === 'INPUT' && input.closest('.grid[data-item-id]')) {
                        const row = input.closest('.grid[data-item-id]');
                        const itemId = row.dataset.itemId;
                        
                        const inputs = row.querySelectorAll('input');
                        const desc = inputs[0].value;
                        const qty = inputs[1].value;
                        const price = inputs[2].value;
                        
                        // Değişiklikleri anında önizlemeye yansıt
                        const itemIndex = currentInvoiceItems.findIndex(item => item.id === itemId);
                        if(itemIndex !== -1) {
                            currentInvoiceItems[itemIndex].desc = desc;
                            currentInvoiceItems[itemIndex].qty = parseFloat(qty) || 0;
                            currentInvoiceItems[itemIndex].unitPrice = parseFloat(price) || 0;
                            updateInvoicePreview();
                            saveData(); // Kaydet
                        }
                    }
                });


                // 4. PDF Kaydetme
                elements.saveBtn.addEventListener('click', () => {
                    // PDF oluştururken sadece önizleme içeriğini kullan
                    const input = elements.invoicePreview;
                    
                    // Gizli elemanları geçici olarak görünür yapıp, sonra gizleyeceğiz (daha iyi render için)
                    const originalStyles = {};
                    const logoContainer = document.getElementById('previewLogoContainer');
                    
                    // Logo kontrolü
                    if(elements.uploadedLogo.src) {
                        originalStyles.display = logoContainer.style.display;
                        logoContainer.style.display = 'block'; // SVG'yi gizleyip img'i gösterdik
                    }

                    // PDF Oluşturma
                    html2canvas(input, { scale: 2 })
                        .then((canvas) => {
                            const imgData = canvas.toDataURL('image/png');
                            const pdf = new jspdf.jsPDF('p', 'mm', 'a4');
                            
                            const pdfWidth = pdf.internal.pageSize.getWidth();
                            const pdfHeight = pdf.internal.pageSize.getHeight();
                            
                            const imgHeight = canvas.height * pdfWidth / canvas.width;
                            let heightLeft = imgHeight;
                            
                            let position = 0;
                            
                            pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, imgHeight);
                            heightLeft -= pdfHeight;
                            
                            while (heightLeft >= 0) {
                                position = heightLeft - imgHeight;
                                pdf.addPage();
                                pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, imgHeight);
                                heightLeft -= pdfHeight;
                            }
                            
                            pdf.save("Fatura_" + (elements.invoiceNumber.value || "Yeni") + ".pdf");
                            
                            // Stilleri geri yükle
                            if (originalStyles.display !== undefined) {
                                logoContainer.style.display = originalStyles.display;
                            }
                        });
                });

                // 5. Verileri Kopyala
                elements.copyBtn.addEventListener('click', () => {
                    const { subtotal, vatAmount, total, vatRate } = calculateTotals();
                    
                    let dataString = `--- ${DOMAIN} Fatura Özeti ---\n\n`;
                    dataString += `FATURA NO: ${elements.invoiceNumber.value || '-'}\n`;
                    dataString += `TARİH: ${elements.invoiceDate.value || '-'}\n\n`;
                    
                    dataString += `GÖNDEREN:\n${elements.senderName.value}\n${elements.senderAddress.value}\nE-posta: ${elements.senderEmail.value}\nVergi ID: ${elements.senderTaxId.value}\n\n`;
                    
                    dataString += `ALICI:\n${elements.recipientName.value}\n${elements.recipientAddress.value}\nİlgili: ${elements.recipientContact.value}\n\n`;

                    dataString += "HİZMET KALEMLERİ:\n";
                    currentInvoiceItems.forEach(item => {
                        dataString += `- ${item.desc} | Miktar: ${item.qty} | Fiyat: ${formatCurrency(item.unitPrice)} | Toplam: ${formatCurrency(item.qty * item.unitPrice)}\n`;
                    });

                    dataString += `\n--- ÖZET ---\n`;
                    dataString += `Ara Toplam: ${formatCurrency(subtotal)}\n`;
                    dataString += `KDV (${vatRate}%): ${formatCurrency(vatAmount)}\n`;
                    dataString += `GENEL TOPLAM: ${formatCurrency(total)}\n\n`;
                    dataString += `NOTLAR: ${elements.invoiceNotes.value}`;
                    
                    navigator.clipboard.writeText(dataString).then(() => {
                        alert('Fatura verileri başarıyla panoya kopyalandı!');
                    }).catch(err => {
                        console.error('Kopyalama hatası:', err);
                        alert('Kopyalama başarısız oldu.');
                    });
                });
                
                // 6. Logo Yükleme
                elements.uploadTrigger.addEventListener('click', () => {
                    elements.logoUpload.click();
                });

                elements.logoUpload.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function(event) {
                            const imgDataUrl = event.target.result;
                            elements.uploadedLogo.src = imgDataUrl;
                            elements.uploadedLogo.classList.remove('hidden');
                            elements.defaultLogo.classList.add('hidden');
                            saveData();
                        };
                        reader.readAsDataURL(file);
                    }
                });
            };

            // Uygulamayı Başlat
            loadData();
            setupEventListeners();
            updateInvoicePreview(); // Başlangıç render'ı
        });
    </script>
</body>
</html>